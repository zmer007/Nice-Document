## 原理
### Camera2 流程
### Camera2 API 简介

### 相关知识点
1. 什么是Surface、SurfaceTexture 与 TextureView，有什么用，有什么联系

## 实践

第 1 阶段

### 完成功能
1. 预览功能
2. 拍照功能

### 问题

**看得见问题**

**1. 预览变形**

原因：相机支持的成像尺寸与 TextureView 展示尺寸不一致，导致成像映射到 TextureView 上时发生形变。

解决方案：调整 TextureView 大小，使其宽高比与相机成像宽高比一致。获取相机支持的分辨率，选中一个如, 140x160, 设置 TextureView 宽高比为 14:16，然后设置 TextureView 对象中 SurfaceTexture 缓存大小（`setDefaultBufferSize(140, 160)`）间接设置相机获取图象的尺寸。此时 TextureView尺寸 与 相机成像尺寸一致，变形问题消失。

**2. 预览成像有锯齿**

原因：相机成像尺寸分辨率较低。解决预览变形时，使用的分辨率为 140x160，TextureView 的比例为 14:16 但是放大到整个屏幕，所以相当于相机成像被放大了，所以会出现锯齿现象。

解决方案：使用合适的相机支持的成像尺寸输出图像。不能使用太大的，图像超出屏幕后会进行缩小，也会造成失真（2倍关系不会失真），同时图像太大也会占用过多内存。可以使用下面方法设置合适的预览尺寸

0 确定相机目的（**暂时不确定录像是如何操作，写完录像后 review 这部分**）

是拍照吗，拍什么格式的照片？是录像吗，录什么格式的影像？以下以拍摄 JPEG 图片为例

1 确定相机输出格式

确定相机输出格式后，可以获取到相机支持该格式的所有尺寸值，从中选取一个做为目标尺寸（targetSize）。

2 预览尺寸以 targetSize 为标准获取相机可以输出到屏幕的值

获取 `getOutputSizes(SurfaceTexture::class.java)` 获取相机支持的预览值，注意，Camera2 API 限制此值最大为 1920x1080。从这些值中过滤出与 targetSize 宽高比一样的值，这样可以做到拍摄的照片与预览的画面是一致的；否则会出现看到的是一个样，拍出的是另一个样，很难对齐。

3 一种简单的适配策略

1. 遍历所有预览值，挑选出与 targetSize 宽高比一致的，将其面积小于 targetSize 的值记作 notBigEnough，其它比值一样的记作 bigEnough
2. 判断 bigEnough 是否为空，不为空则取其中最小值作为预览尺寸，否则
3. 判断 notBigEnough 是否为空，不为空则取其中最大值作为预览尺寸，否则
4. 取面积与 targetSize 面积最接近的一个

**3. 保存的图片方向拍摄时不一致**

原因：一般相机都是相对竖屏设备方向旋转 90 度摆放，也有旋转 270 度摆放的，比如 Nexus 5X，所以会出现成像与设备方向不一致。

解决方案：创建 `CaptureRequest` 时，设置 `JPEG_ORIENTATION` 角度。

**4. 保存的图片模糊**

原因：未对焦，拍照输出尺寸分辨率太低

解决方案：创建 `ImageReader` 时，指定较高分辨率。

**5. 快速重复点击拍摄应用会卡死**

## 未定位的问题
1. 获取到相关元件的旋转方向为 90 度，为什么在竖屏预览中显示为正常角度而拍摄的图片为旋转 -90 度？预览也应该为 -90 度才对？什么地方设置了此属性？